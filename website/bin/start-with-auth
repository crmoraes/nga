#!/usr/bin/env bash

# NGA Interpreter startup script
# Starts both the auth server and nginx

set -e

# Configuration
AUTH_PORT=${AUTH_PORT:-3001}
export AUTH_PORT

echo "=========================================="
echo "NGA Interpreter Startup"
echo "=========================================="

# Check password protection status
if [ -n "$HTTP_AUTH_PASS" ]; then
    echo "Password protection: ENABLED"
    echo "Session timeout: 1 hour"
else
    echo "Password protection: DISABLED"
fi

# Start the auth server in background
echo "Starting auth server on port $AUTH_PORT..."
node auth-server.js &
AUTH_PID=$!

# Wait for auth server to be ready
echo "Waiting for auth server to start..."
sleep 2

# Check if auth server started successfully
if ! kill -0 $AUTH_PID 2>/dev/null; then
    echo "ERROR: Auth server failed to start"
    exit 1
fi

echo "Auth server started (PID: $AUTH_PID)"

# Handle shutdown - stop both processes
cleanup() {
    echo "Shutting down..."
    kill $AUTH_PID 2>/dev/null || true
    exit 0
}
trap cleanup SIGTERM SIGINT

# Start nginx (this will run in foreground)
echo "Starting nginx..."
echo "=========================================="
exec bin/start-nginx-solo
