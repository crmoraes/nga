daemon off;
worker_processes <%= ENV['NGINX_WORKERS'] || 4 %>;

events {
    use epoll;
    accept_mutex on;
    worker_connections <%= ENV['NGINX_WORKER_CONNECTIONS'] || 1024 %>;
}

http {
    # Inline MIME types for Heroku compatibility
    types {
        text/html                             html htm;
        text/css                              css;
        text/plain                            txt md;
        application/javascript                js;
        application/json                      json;
        application/wasm                      wasm;
        image/gif                             gif;
        image/jpeg                            jpeg jpg;
        image/png                             png;
        image/svg+xml                         svg;
        image/x-icon                          ico;
        font/woff                             woff;
        font/woff2                            woff2;
    }
    default_type application/octet-stream;
    sendfile on;
    server_tokens off;

    # Gzip compression
    gzip on;
    gzip_comp_level 2;
    gzip_min_length 512;
    gzip_proxied any;

    log_format l2met 'measure#nginx.service=$request_time request_id=$http_x_request_id';
    access_log logs/nginx/access.log l2met;
    error_log logs/nginx/error.log;

    # Upstream for auth server
    upstream auth_server {
        server 127.0.0.1:<%= ENV['AUTH_PORT'] || 3001 %>;
    }

    server {
        listen <%= ENV["PORT"] %>;
        server_name _;
        keepalive_timeout 5;

        # Root is relative to /app on Heroku
        root /app;
        index index.html;

        <% if ENV['HTTP_AUTH_PASS'] %>
        # ===== Cookie-Based Session Authentication =====

        # Internal auth verification endpoint (used by auth_request)
        location = /internal/auth/verify {
            internal;
            proxy_pass http://auth_server/api/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Cookie $http_cookie;
        }

        # API endpoints - proxy to auth server (publicly accessible)
        location /api/ {
            proxy_pass http://auth_server;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # Login page - publicly accessible (no authentication)
        location = /login.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            try_files $uri =404;
        }

        # Styles for login page - publicly accessible
        location = /styles.css {
            add_header Cache-Control "public, max-age=3600";
            try_files $uri =404;
        }

        # Protected routes - use auth_request for session validation
        location / {
            auth_request /internal/auth/verify;
            auth_request_set $auth_status $upstream_status;
            error_page 401 = @login_redirect;
            add_header Cache-Control "public, max-age=3600";
            try_files $uri $uri/ /index.html;
        }

        # Redirect handler for unauthenticated requests
        location @login_redirect {
            return 302 /login.html;
        }

        # WASM files - protected
        location ~* \.wasm$ {
            auth_request /internal/auth/verify;
            error_page 401 = @login_redirect;
            add_header Cache-Control "public, max-age=2592000, immutable";
            try_files $uri =404;
        }

        # Static assets - protected (except styles.css handled above)
        location ~* \.(js|png|jpg|jpeg|gif|ico|svg|woff|woff2|json|yaml|yml|md)$ {
            auth_request /internal/auth/verify;
            error_page 401 = @login_redirect;
            add_header Cache-Control "public, max-age=3600";
            try_files $uri =404;
        }

        <% else %>
        # ===== No Password Protection =====

        # API endpoints still available (for health checks, etc.)
        location /api/ {
            proxy_pass http://auth_server;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # SPA fallback - serve index.html for all routes
        location / {
            add_header Cache-Control "public, max-age=3600";
            try_files $uri $uri/ /index.html;
        }

        # WASM files with correct MIME type and long cache
        location ~* \.wasm$ {
            add_header Cache-Control "public, max-age=2592000, immutable";
            try_files $uri =404;
        }

        # Static assets caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|json|yaml|yml|md)$ {
            add_header Cache-Control "public, max-age=3600";
            try_files $uri =404;
        }
        <% end %>
    }
}